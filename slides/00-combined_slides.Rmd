---
title: "Introduction to data visualisation with `ggplot2`"
author: "Ben Matthews and Eilidh Jack"
date: "2020-06-29"
output: 
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE,
                      error = TRUE,
                      fig.asp = 0.618)
library(ggplot2)
library(sf)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_solarized_light()

```


name: title
class: center, middle, inverse

# Introduction to data visualisation with `ggplot2`

Ben Matthews<sup>1</sup> and Eilidh Jack<sup>2</sup>

2020-06-29  (Last updated `r Sys.Date()`)

<sup>1</sup>University of Edinburgh

<sup>2</sup>University of Glasgow


`r knitr::include_graphics("https://www.understanding-inequalities.ac.uk/sites/all/themes/theme935/logo.png")`


---


# Welcome!

- [Course outline](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/course_outline.md)

- Who we are

- [Code of conduct](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/code_of_conduct.md)

---
# Learning outcomes

By the end of the course you will:

- Understand (some) basic principles of __data visualization__
- Be able to visualize data with `ggplot2`; scatterplots, bar charts, fitted lines
- Understand (some) basic principles of __mapping__
- Be able to draw maps of spatial data with `ggplot2`


---

name: outline

# Course outline

- [What is `ggplot2`?](https://benmatthewsed.github.io/ui-data-visualization-course/#what-is-ggplot)
- [Concepts in the grammar of graphics](https://benmatthewsed.github.io/ui-data-visualization-course/#concepts-grammar-graphics)
- [Types of geom](https://benmatthewsed.github.io/ui-data-visualization-course/#geom-types)
- [Principles of data visualization](https://benmatthewsed.github.io/ui-data-visualization-course/#principles-data-viz)
- [gg-gotchas](https://benmatthewsed.github.io/ui-data-visualization-course/#gggotchas)
- [Mapping with `ggplot2`](https://benmatthewsed.github.io/ui-data-visualization-course/#ggplot-maps)
- [`ggplot2` colour scales](https://benmatthewsed.github.io/ui-data-visualization-course/#ggplot-colour-scales)
- [Annotations](https://benmatthewsed.github.io/ui-data-visualization-course/#ggplot-annotations)
- [Publication-ready plots](https://benmatthewsed.github.io/ui-data-visualization-course/#publication-plots)

---

# Points of order

- __Ask questions whenever__ `r emo::ji('thumbsup')` You can do this through the Blackboard chat facility __{demo this now}__
- We've structured the sessions with regular breaks, but __if you need to leave just leave__!
- Materials will live online ([slides](https://benmatthewsed.github.io/ui-data-visualization-course/), [other materials](https://github.com/benmatthewsed/ui-data-visualization-course)) so you can access them any time
- __"You're not working from home, you're at home during a crisis trying to work"__
- We'll have a mix of presentations and practical exercises - please keep your camera __on__ and your mic __off__ during the presentations
- We want this time to be as useful for you guys as possible, so __please let us know anything we can improve on__ between now and next week's session



---

# Small-group programming

- For the practical exercises we've divided you guys up into __groups of three__
- When we come to the practical sessions we'll split you out into Collaborate's __break-out rooms__
- Work on the exercises independently
- If you have a question __please ask your group chat first__
- If your group can't resolve the issue then __please raise your hand__ and a moderator will join your group __{demo this now}__
- We'll __circulate through groups__ to see if everyone is getting on okay even if you don't have your hand up

---

# What happens if I lose connectivity?

- In our testing it seems like there can be __connectivity issues__ switching between breakout groups and the main session
- __We'll check__ at the end of the breakout sessions to see if everyone has made it back in okay
- Sometimes it helps to __close your browser__ and rejoin the session
- If it all goes wrong and you can't rejoin __it's okay!__
- You can __access the materials any time__ (see links on previous page)
- I think 'lectures' and live-coding is being recorded, but there's already an __excellent [series of videos on YouTube]("https://www.youtube.com/watch?v=t6IIJEoqPyk&list=PLRPB0ZzEYegPa4uvvAVJnr6loSKbN4wLb")__ covering how to use `ggplot2`


---

# `R` set-up

- We __very much recommend__ that you use a local installation of `R` and `RStudio` on your own computer
- If you haven't got a working R and Rstudio set-up you can send Eilidh a message now in the group chat and she can help get you set-up
- If this still doesn't work you can access a __cloud version__ of `R` with the course dataset and materials [here](https://rstudio.cloud/project/27200)
- You can access the exercises __[here] {add link to exercises}__


---

# Who you are

- Why this course?
- What do you want to achieve?

---

class: center, middle, inverse

# Before we begin...



---
# Why plot in the first place?

`r knitr::include_graphics("https://d2f99xq7vri1nk.cloudfront.net/DinoSequentialSmaller.gif")`

The __datasaurus__ -- [Matejka and Fitzmaurice](https://www.autodeskresearch.com/publications/samestats)


---

name: what-is-ggplot
class: center, middle, inverse

# What `*`is`*` `ggplot2`?

---


# What is `ggplot2`?

- It's an `R` package that draws graphs, developed by [Hadley Wickham](http://hadley.nz/)

- From the [tidyverse website](https://ggplot2.tidyverse.org/): "`ggplot2` is a system for declaratively creating graphics, based on The Grammar of Graphics. You provide the __data__, tell `ggplot2` how to __map variables to aesthetics__, what __[visual marks to use__ to represent data points], and it takes care of the details."

- ... and what's the Grammar of Graphics? Our `ggplot2` [cheat sheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf) says this is "the idea that you can __build every graph from the same components__: a data set, a coordinate system, and `geom`s—visual marks that represent data points." 

---
class: center, middle, inverse

# Great, so why plot with `ggplot2`?

---
class: center, middle, inverse

# 1. Aids perception `r emo::ji("bulb")`

---

## Perception

- Learning `ggplot2` will help you __understand how data visualization works__, how to figure out what you want your plots to look like and describe this to the computer.
- This is because it's __declarative__. You describe to the computer exactly what you want the plot to look like and it draws it for you (rather than, say, picking a type of plot from a menu). You can read a whole [blog post about](http://varianceexplained.org/r/why-I-use-ggplot2/) why this is a good thing!
- So by using `ggplot2` you learn how to make __better__ graphs, not just how to make graphs.

---
class: center, middle, inverse

# 2. It's powerful  `r emo::ji("muscle")`
---

## It's Powerful
- Because it's declarative it's also __flexible__
- You can make pretty pretty much __any type__ of (static) graph you want! (No fancy interactive web graphics though, sorry)
- This is very powerful! You can make __publication__ (or Twitter) quality graphs pretty easily

---
class: center, middle, inverse

# 3. It's popular `r emo::ji("sunglasses")`

---

## It's popular

- There is a large community of users who use `ggplot2` to communicate with very different audiences
- `ggplot2` is used by data journalists at major outlets [BBC](https://bbc.github.io/rcookbook/) and [Financial Times](https://johnburnmurdoch.github.io/slides/r-ggplot/#/)
- As well as technical users who have [extended](https://exts.ggplot2.tidyverse.org/) `ggplot2`'s core functions for specific use cases
- You can use the same tool to visualize data effectively for academic audiences as well as the general public (also just for ourselves), and because users often __post their code online__ you learn from these many users (for example, the online community around the [#TidyTuesday](https://github.com/rfordatascience/tidytuesday) weekly challenges)

---
class: center, middle, inverse

# One more thing before we begin...
---

## `ggplot2` is powerful and fallible

- `ggplot2` is a world unto itself (technically, it's a [domain specific language](http://adv-r.had.co.nz/dsl.html))
- It's also a world with [quirks](https://www.youtube.com/watch?v=vYwXMnC03I4)
- .. so when learning how to use `ggplot2`, mistakes are gonna happen - even for existing `R` users - and that's __fine!__ `r emo::ji("thumbsup")`
- __Every error is an opportunity to learn something__ - we're all building up better mental models of how `ggplot2` works, and finding things that don't work as expected (or at all!) help us do this too `r emo::ji("tada")`
- We'll talk about __common 'gotchas'__ later on


---
class: center, middle, inverse

# Let's dive in:
# `Live coding`

---
class: center, middle, inverse

# `Your turn!`
# Lines __1-237__ in the [exercises](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises.R)
# Lines __1-179__ in the [answers](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises-with-answers.R)


---
class: center, middle, inverse

# Five-minute break


---
name: concepts-grammar-graphics
class: center, middle, inverse

# Concepts in the grammar of graphics

---


class: center, middle, inverse


# __Dataset__ + 
# __mapping__ variables in the dataset to `aes`thetics + 
# __Layers__ of `geom`s (symbols to represent data) = 
# __Plot__


---
class: center, middle, inverse


# __Dataset__ + 
# Mapping variables in the dataset to `aes`thetics + 
# Layers of `geom`s (symbols to represent data) = 
# Plot


---

# Data

- `ggplot2` expects your dataset to be [tidy](https://r4ds.had.co.nz/tidy-data.html):
    1. Each __variable__ must have its own __column__.
    2. Each __observation__ must have its own __row__.
    3. Each __value__ must have its own __cell__.
- From __[R for Data Science](https://r4ds.had.co.nz/tidy-data.html#fig:tidy-structure)__:
`r knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/6f1ddb544fc5c69a2478e444ab8112fb0eea23f8/91adc/images/tidy-1.png")`
- (Don't worry about this during the course - the datasets we're using have been tidied already)


---

class: center, middle, inverse


# Dataset + 
# __Mapping__ variables in the dataset to `aes`thetics + 
# Layers of `geom`s (symbols to represent data) = 
# Plot


---


# Mapping variables to `aes()`thetics

- __Which variables__ in your dataset you want to represent in the plot and __how__
- Most of the time you'll want at least `x` and `y` (these are __position__ `aes`thetics)
- Includes __other visual encodings__ like: colour/fill, shape, line type, alpha (transparency), size...

---

# An example call

.pull-left[

```{r plot-last, fig.show = 'hide'}

# mtcars is a dataset
# that comes with R

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
)

```
]

.pull-right[
```{r ref.label = 'plot-last', echo = FALSE, fig.retina = 3}
```
]

- The call to `aes()` __lets `ggplot` ['see' into your dataset](https://ggplot2.tidyverse.org/reference/aes.html#quasiquotation)__
- If you ask `ggplot` to find a variable in your dataset but don't use `aes()` `ggplot` will __look in the wrong place__
- __Key point__ - if you want `ggplot` know about something __inside your dataset you have to reference it within__ `aes`!


---


# Mapping helps thinking

- This is part of what makes `ggplot` so helpful for __thinking__ about data visualization - you make the plot by choosing how to map variables to aesthetics and then telling `R` 
- This helps me decide __what to emphasise__ in my plots based on what I'm interested in; the same data mapped to different `aes()`thetics can have different emphasis (we'll pick up on this later in our [Principles of data visualization](https://benmatthewsed.github.io/ui-data-visualization-course/#principles-data-viz) session)
- (Obviously you can do this with other plotting programs too, but I think because `ggplot` is __declarative__ the process is more explicit)


---

class: center, middle, inverse


# Dataset + 
# Mapping variables in the dataset to `aes`thetics + 
# __Layers__ of `geom`s (symbols to represent data) = 
# Plot


---

# `geom`etric symbols to represent data

- __What__ symbols you want `ggplot` to draw to represent the data; lines, points, errorbars, ribbons, contours...
- You add these to the plot in __layers__
- You can have exactly the __same mapping__ of variables to `aes`thetics, but __different `geom`s__

---

.pull-left[

```{r same_aes, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point()

```
]

.pull-right[
```{r ref.label = 'same_aes', echo = FALSE, fig.retina = 3}
```
]

---

.pull-left[
```{r same_aes_2, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line()

```
]

.pull-right[
```{r ref.label = 'same_aes_2', echo = FALSE, fig.retina = 3}
```
]

---

# Layers and `geom`s

- `ggplot2` builds plots out of __layers__
- This makes it suuuuuuper flexible - you can just __stack layers on top of each other__!
- `geom`s only add __one layer at a time__
- __Add__ layers together with `+` __operator__


---
.pull-left[
```{r layers, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_line()

```
]

.pull-right[
```{r ref.label = 'layers', echo = FALSE, fig.retina = 3}
```
]




---

# `geom`s and `aes`thetics

- __Every__ `geom` __needs__ a dataset and a mapping of variables to `aes`thetics
- Layers (silently!) __inherit__ data and `aes` mappings that you set __for the whole plot__...
- ... but you can set data and aesthetics for whole plot and for each layer __separately__, so you can override this default behaviour
- This is often very helpful but also a big source of pain - __THERE BE DRAGONS__ `r emo::ji("dragon")`
- Again, if you want a layer to reference something in your dataset you need to tell it with `aes`


---


.pull-left[
```{r layer_aes, fig.show = 'hide'}

# cyl is another variable in mtcars

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line() +
  geom_point(
    aes(colour = cyl)
    ) 

```
]

.pull-right[
```{r ref.label = 'layer_aes', echo = FALSE, fig.retina = 3}
```
]

---

# Set `geom` parameters with `aes` or with a fixed value?

- You use `geom`s to visually represent values of the __variables in your dataset__
- But sometimes you also want to change how a `geom` looks to a __fixed value__ (i.e. one that __doesn't__ come from a variable) in your dataset - like making all the points in a scatterplot red
- If it's __within the call to `aes`__, `ggplot2` will look for it __in your dataset__
- If it's __outside the call to `aes`__, `ggplot2` will apply the __value you supply directly__


---
# Some notes on `aes()`

- For technical reasons we won't go into now __quotation marks matter__ here (if you want you can read all about why [here](https://adv-r.hadley.nz/metaprogramming.html))
- This was a __common source of errors__ for me when learning `ggplot2` (and still is!) and my own mental model of when and why to use quote marks is pretty crude even now. So it's natural that this feels weird or arbitrary right now `r emo::ji("thumbsup")`
- Most of the time, if it's __inside__ the call to `aes` __don't__ use quotes

---

.pull-left[
```{r layers_error, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line(
    aes(colour = red)
  ) +
  geom_point() 

```
]

.pull-right[
```{r ref.label = 'layers_error', echo = FALSE, fig.retina = 3}
```


]

---

.pull-left[
```{r layers_error_2, fig.show = 'hide', error = FALSE}

# not the quotation marks around "red"

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line(
    colour = "red"
  ) +
  geom_point() 

```
]

.pull-right[
```{r ref.label = 'layers_error_2', echo = FALSE, fig.retina = 3}
```


]



---

class: center, middle, inverse

# In review

---

class: center, middle, inverse

# __Dataset__ + 
# __Mapping__ variables in the dataset to `aes`thetics + 
# __Layers__ of `geom`s (symbols to represent data) = 
# __Plot__


---

class: center, middle, inverse

# If you want `ggplot` to know about something in your dataset, use `aes()`

---

class: center, middle, inverse

# Any questions?




---
name: geom-types
class: center, middle, inverse

# The three types of `geom` layer

---

# Three types of `geom`

- I like to think of `geom`s as being one of three types:
- `geom`s that plot __each datum__ for you
- `geom`s that plot __summaries__ of your dataset for you
- `geom`s that plot __things that aren't in your dataset__ (like reference lines and such); often metadata
- (NB The official `ggplot` book uses a [slightly different classification system](https://ggplot2-book.org/toolbox.html) for `geom`s, it's a pretty similar idea)
- Different `geom`s require __different mappings of variables__

---

# Plot each datum please

- Make a mark on the plot for __each row__ in the dataset (we saw this kind already)
- 

    - `geom_point`
    - `geom_line
    - `geom_area`
    - `geom_bar(stat = "identity)`
    - `geom_sf()` (we'll come back to this in the next session)
    - `geom_text()`
    - `geom_errorbar` (sort of)

- These `geom`s usually require __mapping to `x` and `y` axes__

---

# Plot a summary of my data please

- Plot something that __summarises__ all/groups of the data in my dataset
- Univariate/distributions:
    - `geom_histogram`
    - `geom_density`
    - `geom_violin`
    - `geom_bar` (sort of)
- Bivariate:
    - `geom_smooth`
    - `geom_contour`
    - `geom_boxplot` (with one continuous and one discrete variable)
- You need __`x` and `y`__ mappings for __bivariate__ summaries, but __univariate__ summaries __only need `x`__

---

# A univariate example


.pull-left[

```{r univar_geom, fig.show = 'hide'}

# note we only map x here - 
# because we're only drawing one variable

ggplot(
  data = mtcars,
  mapping = aes(x = disp)
) +
  geom_density()

```
]

.pull-right[
```{r ref.label = 'univar_geom', echo = FALSE, fig.retina = 3}
```
]


---

# Bivariate example

.pull-left[

```{r bivar_geom, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_smooth()

```
]

.pull-right[
```{r ref.label = 'bivar_geom', echo = FALSE, fig.retina = 3}
```
]


---

# And we can add layers to this

.pull-left[

```{r bivar_geom_dat, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_smooth()

```
]

.pull-right[
```{r ref.label = 'bivar_geom_dat', echo = FALSE, fig.retina = 3}
```
]

---

# Why stop there?


.pull-left[

```{r bivar_geom_den, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_smooth() +
  geom_density_2d()

```
]

.pull-right[
```{r ref.label = 'bivar_geom_den', echo = FALSE, fig.retina = 3}
```
]

    
---

name: reference-lines

# Plot something else on my graph
- Reference lines
    - `geom_vline(xintercept = )`
    - `geom_hline(yintercept = )`
    - `geom_abline(slope = , intercept = )`
- Annotations
    - `geom_text(aes(label = ))` (... sort of)
- Reference lines need intercepts __specified outside of `aes()`__, but text labels need the specific `label` mapped to a variable in a dataset using `aes()`



---

# Adding a reference line


.pull-left[

```{r bivar_geom_den_2, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_smooth() +
  geom_density_2d() +
  geom_vline(xintercept = 200)

```
]

.pull-right[
```{r ref.label = 'bivar_geom_den_2', echo = FALSE, fig.retina = 3}
```
]

---

# Adding text


.pull-left[


- It's kind of a lie to have `geom_text` here, because you use it to add values from your dataset using `aes()` (in this case, the values from the `y` axis):


```{r geom_text, fig.show = 'hide'}


ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_smooth() +
  geom_density_2d() +
  geom_vline(xintercept = 200) +
  geom_text(
    aes(label = drat)
  )

```
]

.pull-right[
```{r ref.label = 'geom_text', echo = FALSE, fig.retina = 3}
```
]


---

# Adding text

.pull-left[

- But mostly I use it with a separate __dataframe of labels__

```{r geom_text_2, fig.show = 'hide'}

label_df <- 
  data.frame(
    x = 300,
    y = 4,
    text = "A great label"
  )

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point() +
  geom_smooth() +
  geom_density_2d() +
  geom_vline(xintercept = 200) +
  geom_text(
    data = label_df,
    mapping = aes(x = x,
                  y = 4,
                  label = text)
  )

```
]

.pull-right[
```{r ref.label = 'geom_text_2', echo = FALSE, fig.retina = 3}
```
]



---
class: center, middle, inverse

# Recap:
# There are three types of `geom`
# Different types need different `aes`thetic mappings

---
class: center, middle, inverse
# `Your turn!`
# Lines __238-705__ in the [exercises](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises.R)
# Lines __180-603__ in the [answers](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises-with-answers.R)

---

name: facets
class: center, middle, inverse
# Facets

---

# ... facets?

- From the [`ggplot2` book](https://ggplot2-book.org/getting-started.html#qplot-facetting): "Facetting creates __tables of graphics__ by splitting the data into subsets and displaying the __same graph for each subset__"
- Just add a `facet_wrap()` layer to a `ggplot` call
- Tell `ggplot` __which variable(s)__ to facet using a call to `vars()` (this acts like `aes()` but for `facet`s)
- `ggplot` then makes a long string of plots - one for each level of the facetting variable - which it __wraps__ into a table
- Why can't we just use `aes()` here too? Apparently `vars()` can [handle more complicated expressions than `aes()`](https://ggplot2.tidyverse.org/reference/vars.html), which lets you tweak your facets in some helpful ways. I (Ben) only learned this writing the course!

---

# An example of facetting

.pull-left[
```{r facet, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line() +
  geom_point(
    aes(colour = cyl)
    ) +
  facet_wrap(
    facets = vars(cyl)
    )

```
]

.pull-right[
```{r ref.label = 'facet', echo = FALSE, fig.retina = 3}
```
]



---
# An example of facetting

.pull-left[

You can facet by multiple variables

```{r facet_2, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line() +
  geom_point(
    aes(colour = cyl)
    ) +
  facet_wrap(
    facets = vars(am, cyl)
    )

```

]

.pull-right[
```{r ref.label = 'facet_2', echo = FALSE, fig.retina = 3}
```
]

---
# Adjusting the scales


.pull-left[

You can change how the __axes__ are displayed by setting `scales = `. This focuses on the trends __within__ the plot and makes it harder to see trends __between__ plots.

```{r facet_grid, fig.show = 'hide'}

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_line() +
  geom_point(
    aes(colour = cyl)
    ) +
  facet_wrap(
    facets = vars(am, cyl),
    scales = "free_y"
    )

```

]

.pull-right[
```{r ref.label = 'facet_grid', echo = FALSE, fig.retina = 3}
```
]



---


# Going further with `facets`

- The `ggplot` book has a [whole section](https://ggplot2-book.org/facet.html#facet-wrap) on facetting
- You can allow facets to have __different scales__ using the `scales = ` argument. By default all the facets have the same scale, but you can allow each axis to vary by setting `scales = "free_y"`, `scales = "free_x"` or `scales = "free"`


---
class: center, middle, inverse
# `Your turn!`
# Lines __706-796__ in the [exercises](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises.R)
# Lines __604-687__ in the [answers](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises-with-answers.R)


---
class: center, middle, inverse

# Five-minute break

---

name: principles-data-viz
class: center, middle, inverse
# Principles of data visualization

---


# Principles of data visualization

- How we read graphs
- Principles of chart design
- An example

---

# How we read graphs

.pull.left[

- __Some visual comparisons are easier__ to make than others

1. Position along a common scale
2. Position along identical, non-aligned scales
3. Length
4. Angle or slope
5. Area
6. Volume
6. Colour hue / saturation

(Source: Cleveland and McGill, 1984)

]

.pull-right[

```{r cleveland, out.width = '45%', echo = FALSE}
 knitr::include_graphics("https://www.researchgate.net/profile/Chia_Shen/publication/221513994/figure/fig2/AS:305590816526337@1449869936222/Cleveland-and-McGills-elementary-perceptual-tasks-All-visual-representations-of.png")
```


]

---

#  How we read graphs (2)

- __Proximity__: "objects or shapes that are close to one another appear to form groups... __place items to compare close together__, and less important comparisons further apart" (this is from a very interesting [review of research into how we understand graphs by Vanderplas, Cook and Hofmann](https://www.annualreviews.org/doi/full/10.1146/annurev-statistics-031219-041252))
    - ... so think about how your __mapping of variables__ to aesthetics and facets __highlights some comparisons__ and not others
   
```{r vanderplas, out.width = '50%', echo = FALSE}
knitr::include_graphics("https://www.annualreviews.org/na101/home/literatum/publisher/ar/journals/content/statistics/2020/statistics.2020.7.issue-1/annurev-statistics-031219-041252/20200226/images/medium/st070061.f11.gif")
```
---
    
# Principles of chart design
- __[Match perceptual and data topology](http://stat405.had.co.nz/lectures/20-effective-vis.pdf)__: Some `aes`thetic mappings have implicit __orders__ (like position and size), others are __unordered__ (like shape)
   - If you’re using a graphical element to show relative size of quantities __make larger size = larger quantity__


---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-1, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-0.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-2, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-1.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-3, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-2.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-4, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-3.gif")
```
---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-5, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-4.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-6, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-5.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-7, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-6.gif")
```

---

# Principles of chart design
- From Hadley Wickham's [excellent slides on data-viz](http://stat405.had.co.nz/lectures/20-effective-vis.pdf):

```{r wickham-8, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/page-7.gif")
```


---
#  Principles of chart design (2)
- __Dual coding__: You can encode the same variables to multiple aesthetic parameters (easily in `ggplot2`) to aid comprehension
- This can also aid __accessibility__ by reducing reliance on e.g. colour to distinguish variables


.pull-left[

```{r dual_code, fig.show = 'hide'}

# code am to colour

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point(
    mapping = aes(colour = am)
  )

```
]

.pull-right[
```{r ref.label = 'dual_code', echo = FALSE, fig.retina = 3}
```
]

---

#  Principles of chart design (2)
- __Dual coding__: You can encode the same variables to multiple aesthetic parameters (easily in `ggplot2`) to aid comprehension
- This can also aid __accessibility__ by reducing reliance on e.g. colour to distinguish variables


.pull-left[

```{r dual_code_2, fig.show = 'hide'}

# code am to shape as well
# note - I had to cheat here and ask ggplot2 to treat
# am as a factor variable!

ggplot(
  data = mtcars,
  mapping = aes(x = disp, y = drat)
) +
  geom_point(
    mapping = aes(colour = am,
                  shape = factor(am))
  )

```
]

.pull-right[
```{r ref.label = 'dual_code_2', echo = FALSE, fig.retina = 3}
```
]


---

#  Principles of chart design (3)
- You can also colour scales designed to have __good perceptual properties__ for [different kinds of colour-blindness](https://serialmentor.com/dataviz/color-pitfalls.html#not-designing-for-color-vision-deficiency) (`ggplot2` defaults aren't so good for this) (we'll cover some of these later in the course)


---

# Principles of chart design (4)

- Plot the __raw data__ and the __summary__
- Remember the [datasaurus!](https://www.autodeskresearch.com/publications/samestats)

`r knitr::include_graphics("https://d2f99xq7vri1nk.cloudfront.net/DinoSequentialSmaller.gif")`


---

# Telling stories with charts

- Think about how each plot fits into the [story you're telling](https://serialmentor.com/dataviz/telling-a-story.html)
- It's totally fine to graph data __two or more times__ if it helps to tell the story (Cleveland 1985)
- I think `ggplot` helps with this because it allows you to __iterate__ towards your final chart by building up layers

---

# An example

.left-column[
- Use the __grammar of graphics__ to describe this plot
- In your groups, take __three minutes__ to discuss:
    - Which __attributes__ are emphasised most?
    - How could this figure be plotted differently or __improved__?

]

.right-column[

```{r my_graph, out.width = '60%', echo = FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/benmatthewsed/ui-data-visualization-course/master/figures/thesis_figure.png")
```

Age-crime curves for different crime types in Scottish Offenders Index 1989-2011, men (Source: [Ben's PhD thesis](https://era.ed.ac.uk/handle/1842/25810))

]

---

# How I'd describe this figure with the grammar of graphics

Aspect of Grammar	| Variable
------------------|-------
`Data`set	| Scottish Offenders Index
`Aes`thetic:	|
  X	| Age
	Y	| Conviction rate
	Line type	| Year
	Colour	| Crime type
`Geom`	| Line
`Facet`  |	Crime type



---
name: gggotchas
class: center, middle, inverse
# `gg`-gotchas


---

# 1. "Sawtooth" lines

.pull-left[

- [From R For Data Science](https://ggplot2-book.org/collective-geoms.html):

```{r bad_plot, out.width = '50%', echo = FALSE}
 knitr::include_graphics("https://ggplot2-book.org/collective-geoms_files/figure-html/oxboys-line-bad-1.png")
```

]

.pull-right[

- __Diagnosis__: ["This vis problem often means there is some grouping characteristic missing from the graphic"](https://www.njtierney.com/post/2020/06/14/jq-sawtooth/)
- __Prescription__: Check the data for any more grouping variables you might've missed (e.g. if your dataset is values for multiple years and you haven't included year in the plot)

]

---
## "`Error: Each group consists of only one observation. Do you need to adjust the group aesthetic?`"

- __Diagnosis__: This happens when you try to plot a __line__ using a factor as one of the position scales. `ggplot` then 'guesses' that you want the `x` variable to be the grouping variable
- Data types, and particularly [factors](https://r4ds.had.co.nz/factors.html) matter to `ggplot`!

- __Prescription__: Adjust the group aesthetic! Explicitly tell `ggplot` what variable you want to group by in the call to `aes()` using the `group = ` parameter


---
## `Error: stat_count() can only have an x or y aesthetic`

- __Diagnosis__: This happens with summary `geom`s (usually `geom_bar`) which want to calculate a summary for you but you've already summarised the data outside of ggplot2

- __Prescription__: You can tell `geom_bar` that you've summarised the data already by [specifying `geom_bar(stat = "identity")`](https://stackoverflow.com/a/39679104/10791377) (here `identity` just means "use the numbers that I gave you please and don't calculate anything with them")



---
## `Error: Cannot use +.gg() with a single argument. Did you accidentally put + on a new line?`

- __Diagnosis__: For [technical reasons I don't understand](https://community.rstudio.com/t/why-put-and-at-the-end-of-lines/1831) this isn't valid R code. So you can't do it!

- __Prescription__: Move the `+` to the end of the previous line from the start of the new line

---

## `Error in FUN(X[[i]], ...) : object 'blah' not found`

- __Diagnosis__: `ggplot` is looking for something in your dataset but there are __no variables with that name__
    - See our discussion on concepts in the grammar of graphics about what goes inside the call to `aes` and what goes outside
- __Prescription__: Make sure there aren't any __typos__, and that what you've specified __exists in your dataset__
    - If you're trying to set a colour you might have to move this outside the call to `aes()`
    
---
class: center, middle, inverse

# `Your turn!`
# Lines __797-980__ in the [exercises](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises.R)
# Lines __689-852__ in the [answers](https://github.com/benmatthewsed/ui-data-visualization-course/blob/master/script/exercises-with-answers.R)



---

class: center, middle, inverse

# Recap


---

# What we've learned:

- How to draw graphs with `ggplot2`
- Elements of the __grammar of graphics__
- Principles of __data visualization__

---

class: center, middle, inverse


# Dataset + 
# Mapping variables in the dataset to `aes`thetics + 
# Layers of `geom`s (symbols to represent data) = 
# Plot


---


class: center, middle, inverse

# Three types of `geom`: plot each datum, plot a summary, plot metadata



---

class: center, middle, inverse

# Errors happen and that's fine!


---

# In the next session

- __Maps__
- Beautifying your ggplots with __themes__ and __titles__
- Answering any __questions__ you have between now and then
- Please feel free to bring __your own data__!
- Optional homework: try out this week's [#TidyTuesday](https://github.com/rfordatascience/tidytuesday) challenge



---
name: ggplot-maps
class: center, middle, inverse

# Maps in `ggplot2`

---


1. Maps are great (we take this as axiomatic!)
4. In `R`, maps are "different, and weird" -- [Danielle Navarro](https://djnavarro.net/post/maps/)
3. Maps can be misleading
5. Use with caution!

---


# What are we mapping ?

- If you're on this course we assume that you are:
    - Analysing data about people
    - These people are on Earth, and may well be in the UK
- So you'll [probably have __vector__ data](https://geocompr.robinlovelace.net/spatial-class.html#vector-data) - i.e. __points in space__ (and not raster data, which breaks up space into evenly sized grids, like in ecology or something)
- And mostly you'll be plotting __areal__ data - which relates to some shape bounded in space (like a Local Authority or neighbourhood), and data about these areal entities will likely be __aggregates__ describing the population within that area - e.g. votes, or recorded crimes, or percent unemployed... etc.

---

# Okay, but what "space"?

- Turns out that this is a really complicated question!
- We turn representations of the 3d surface of the Earth into a 2d map using a [coordinate reference system (CRS)](https://geocompr.robinlovelace.net/spatial-class.html#crs-intro)
- This won't come up here `r emo::ji("crossed fingers")` because we've set the CRS for you in our example dataset, but `ggplot2` needs to know the CRS of your data in order to draw the plot
- If your map looks funny it may well be that you have the wrong CRS


---

# Maps in `R` are "different and weird"

---

# Maps in `R`: simple features

- Working with spatial data in `R` is a whole sub-field in itself (see [here](https://geocompr.robinlovelace.net/ from a GIS/geoscience perspective) for a GIS introduction, and [here](https://socviz.co/maps.html#maps) for a social sciences introduction)
- We use the [`{sf}` package](https://r-spatial.github.io/sf/articles/sf1.html)
- The geographical information in your dataset gets a special `geometry` column with our geographical information in
- This is works nicely with tidy data and `ggplot2`
- `ggplot2` figures out how to draw the map based on the CRS, so this changes some of how we would usually ask `ggplot2` to draw the map


---

# Maps can be misleading: 


- __Chloropleth__ maps - coloured in maps - are a good idea when you have high spatial resolution, but can be [misleading when you have low spatial resolution](https://serialmentor.com/dataviz/geospatial-data.html#choropleth-mapping)
- This is because these maps can be [dominated by geographic units with large areas](https://serialmentor.com/dataviz/geospatial-data.html#choropleth-mapping) if the areas of your geographies are very different (this is very much the case for Scottish Local Authorities!)
- ... and such areas often have low populations
- This is not so bad when you're mapping [densities](https://serialmentor.com/dataviz/geospatial-data.html#choropleth-mapping) - where the denominator is the area of the spatial unit

---

# Maps can be misleading: parameter estimates

"[P]lotting observed rates can have __serious drawbacks when sample sizes vary by area__, since very high (and low) observed rates are found disproportionately in poorly-sampled areas. Unfortunately, adjusting the observed rates to account for the effects of small-sample noise can introduce an opposite effect, in which the highest adjusted rates tend to be found disproportionately in well-sampled areas. __In either case, the maps can be difficult to interpret__ because the display of spatial variation in the underlying parameters of interest is confounded with spatial variation in sample sizes" [Gelman and Rice](http://www.stat.columbia.edu/~gelman/research/published/allmaps.pdf) `r emo::ji("scream")`


---

# Maps can be misleading: Who is at risk?

- Mapping counts of things can be confounded by areas with the [highest population](https://socviz.co/maps.html#maps)
- Mapping rates are affected by the sample size issues on the previous slide...
- ... and also the [Modifiable Areal Unit Problem](https://en.wikipedia.org/wiki/Modifiable_areal_unit_problem)


---

# Maps can be misleading: What shapes to draw?

- We're going to focus on the simple case: __polygons__ that represent Local Authority boundaries
- But you might want to change the shapes to adjust for e.g. population size as in a __cartogram__
- Or maybe you want to arrange facets (as in facet_wrap) in the shape of your spatial data as in a [__geofacet__](https://hafen.github.io/geofacet/) (see also Kieran Healy's thoughts on ['Is your data really spatial?'](https://socviz.co/maps.html#is-your-data-really-spatial))

---

# Maps can be misleading
# Use with caution!


---
name: ggplot-colour-scales
class: center, middle, inverse

# Colour scales

---

# `ggplot2` default colour scale

- continuous
- categorical


![ggplot2-default-colour](https://ggplot2-book.org/diagrams/colour-wheel.png)

- You have to make sure `ggplot` is treating your data in the right way (continuous if you want a continuous scale, discrete if you want a discrete scale)

---

# Good defaults

- scale viridis
- scaleOkabeIto ({colorblindr})


# Other options
- scale_colour_grey
- scale_color_brewer()


---

# Advanced - making your own

- If only one colour you want you can set with `colour = "#123456"` using the colour [hex-code](https://www.color-hex.com/)


- For discrete values
- `scale_colour_manual()`

---

name: ggplot-annotations
class: center, middle, inverse

# Annotations and labels

---


---

# On the plots

1. Reference lines (we covered these in [types of geom](#reference-lines))


---


2. `geom_text`
4. Going further - [arrows](https://bbc.github.io/rcookbook/#add_annotations)
3. titles



---

# Adding titles with `labs()`

- `title`, `subtitle` and `captions`
- Can also rename your axes here
- As well as any other `aes`thetic mappings like colour, fill, shape, size...

---

name: publication-plots
class: center, middle, inverse

# Publication-ready plots

---

# Changing the theme
# Tweaking elements of the theme



---

# Themes

- `theme()` is a bit `r emo::ji("scream")`


- changing the theme

- scales

- If you want to change the theme with `theme_{whatever}` AND adjust
properties settings with `theme()` the call to `theme_{whatever}` __must come first!__


---
# `theme()`

- There are [lots of theme components](https://ggplot2.tidyverse.org/reference/theme.html) that you can adjust

- The ones I use the most are:
- Moving legends
- For example, moving the legend from the right of the plot to the bottom
- `legend.position = "bottom"`

- Rotating axis labels if you have overlapping `x`-labels
- `axis.text.x = element_text(angle = 45, hjust = 1)`

---

# Scales

- See https://scales.r-lib.org/


---

# Saving the plot

- Throughout the session we've just let plots print out in the plots pane
- Not so convenient if you want to show someone else your work!
- For [technical reasons I don't understand](https://www.jumpingrivers.com/blog/r-graphics-cairo-png-pdf-saving/) it's best to using the option `type = "cairo-png"` when saving your plot to make it look nice


- `ggsave()`
- `filename = `
- `plot = `
- `type = "cairo-png"`
- `height =`
- `width =`